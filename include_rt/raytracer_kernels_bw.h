#ifndef RAYTRACER_KERNELS_BW_H
#define RAYTRACER_KERNELS_BW_H
#include <curand_kernel.h>
#include "Types.h"
#include "raytracer_functions.h"

using Raytracer_functions::Vector;
using Raytracer_functions::Optics_scat;

#ifdef RTE_RRTMGP_SINGLE_PRECISION
constexpr int bw_kernel_block= 256;
constexpr int bw_kernel_grid = 1024;
#else
constexpr int bw_kernel_block = 256;
constexpr int bw_kernel_grid = 256;
#endif
constexpr Float k_null_gas_min = Float(1.e-3);

struct Grid_knull
{
    Float k_max;
    Float k_min;
};

struct Camera
{
    Vector<Float> position;
    bool fisheye = true;

    // rotation matrix for fisheye version - we need to do implement this in a nice way at some point
    Vector<Float> mx;
    Vector<Float> my;
    Vector<Float> mz;
    Float f_zoom;

    // regular camera
    Float fov;
    Vector<Float> cam_width;
    Vector<Float> cam_height;
    Vector<Float> cam_depth;

    void setup_rotation_matrix(const Float yaw_deg, const Float pitch_deg, const Float roll_deg)
    {
        const Float yaw = yaw_deg / Float(180.) * M_PI;
        const Float pitch = pitch_deg / Float(180.) * M_PI;
        const Float roll = roll_deg / Float(180.) * M_PI;
        mx = {cos(yaw)*sin(pitch), (cos(yaw)*cos(pitch)*sin(roll)-sin(yaw)*cos(roll)), (cos(yaw)*cos(pitch)*cos(roll)+sin(yaw)*sin(roll))};
        my = {sin(yaw)*sin(pitch), (sin(yaw)*cos(pitch)*sin(roll)+cos(yaw)*cos(roll)), (sin(yaw)*cos(pitch)*cos(roll)-cos(yaw)*sin(roll))};
        mz = {-cos(pitch), sin(pitch)*sin(roll), sin(pitch)*cos(roll)};
    }

    void setup_normal_camera(const Camera camera)
    {
        if (!fisheye)
        {
            const Vector<Float> dir_tmp = {0, 0, 1};
            const Vector<Float> dir_cam = normalize(Vector<Float>({dot(camera.mx,dir_tmp), dot(camera.my,dir_tmp), dot(camera.mz,dir_tmp)*Float(-1)}));
            Vector<Float> dir_up;
            if ( (int(dir_cam.z)==1) || (int(dir_cam.z)==-1) )
                dir_up = {1, 0, 0};
            else
                dir_up = {0, 0, 1};

            cam_width = normalize(cross(dir_cam, dir_up));
            cam_height = normalize(cross(dir_cam, cam_width));
            cam_depth = dir_cam / tan(fov/Float(180)*M_PI/Float(2.));
        }
    }

    // size of output arrays, either number of horizontal and vertical pixels, or number of zenith/azimuth angles of fisheye lens
    int ny = 1024;
    int nx = 1024;
};


__global__
void ray_tracer_kernel_bw(
        const int igpt,
        const Int photons_to_shoot,
        const Grid_knull* __restrict__ k_null_grid,
        Float* __restrict__ camera_count,
        Float* __restrict__ camera_shot,
        int* __restrict__ counter,
        const Float* __restrict__ k_ext, const Optics_scat* __restrict__ scat_asy,
        const Float* __restrict__ k_ext_bg, const Optics_scat* __restrict__ scat_asy_bg,
        const Float* __restrict__ z_lev_bg,
        const Float* __restrict__ r_eff,
        const Float* __restrict__ surface_albedo,
        const Float* __restrict__ land_use_map,
        const Float mu,
        const Vector<Float> grid_size,
        const Vector<Float> grid_d,
        const Vector<int> grid_cells,
        const Vector<int> kn_grid,
        const Vector<Float> sun_direction,
        const Camera camera,
        const int nbg,
        const Float* __restrict__ mie_cdf,
        const Float* __restrict__ mie_ang,
        const Float* __restrict__ mie_phase,
        const Float* __restrict__ mie_phase_ang,
        const int mie_table_size);

__device__ Float waves[500] = {0.059265588527588654,
 0.05764390190073014,
 -0.49999999999999994,
 0.8660254037844387,
 784.925963666294,
 0.06192868704133608,
 0.05764390190073014,
 -0.39607976603915673,
 0.918216106880274,
 779.5616441017993,
 0.06398730908205896,
 0.05764390190073014,
 -0.2868032327110902,
 0.9579895123154889,
 394.72898793689757,
 0.06538949352116157,
 0.05764390190073014,
 -0.17364817766693036,
 0.984807753012208,
 259.5648229228317,
 0.06609963412396197,
 0.05764390190073014,
 -0.058144828910475836,
 0.9983081582712682,
 69.55103367145699,
 0.06609963412396197,
 0.05764390190073014,
 0.058144828910475836,
 0.9983081582712682,
 455.9383265192964,
 0.06538949352116157,
 0.05764390190073014,
 0.17364817766693025,
 0.984807753012208,
 90.4963678254077,
 0.06398730908205896,
 0.05764390190073014,
 0.28680323271109015,
 0.9579895123154889,
 613.0944615645311,
 0.06192868704133608,
 0.05764390190073014,
 0.39607976603915673,
 0.918216106880274,
 235.5405032256789,
 0.059265588527588654,
 0.05764390190073014,
 0.49999999999999994,
 0.8660254037844387,
 299.50526483523686,
 0.13265357180540396,
 0.0809703093914234,
 -0.49999999999999994,
 0.8660254037844387,
 646.9887524079069,
 0.1470139548584407,
 0.0809703093914234,
 -0.39607976603915673,
 0.918216106880274,
 929.2357757237463,
 0.15869724792247,
 0.0809703093914234,
 -0.2868032327110902,
 0.9579895123154889,
 586.1067857434496,
 0.16694907275997864,
 0.0809703093914234,
 -0.17364817766693036,
 0.984807753012208,
 555.6966477214839,
 0.1712197850446248,
 0.0809703093914234,
 -0.058144828910475836,
 0.9983081582712682,
 400.22634216055565,
 0.1712197850446248,
 0.0809703093914234,
 0.058144828910475836,
 0.9983081582712682,
 372.0928046105498,
 0.16694907275997864,
 0.0809703093914234,
 0.17364817766693025,
 0.984807753012208,
 435.5035423139724,
 0.15869724792247,
 0.0809703093914234,
 0.28680323271109015,
 0.9579895123154889,
 522.7922794288288,
 0.1470139548584407,
 0.0809703093914234,
 0.39607976603915673,
 0.918216106880274,
 979.8661323937881,
 0.13265357180540396,
 0.0809703093914234,
 0.49999999999999994,
 0.8660254037844387,
 58.744768207886096,
 0.14248629019761827,
 0.10825034527036977,
 -0.49999999999999994,
 0.8660254037844387,
 648.1533980328785,
 0.1762080690134896,
 0.10825034527036977,
 -0.39607976603915673,
 0.918216106880274,
 527.5612524072026,
 0.2063762262880709,
 0.10825034527036977,
 -0.2868032327110902,
 0.9579895123154889,
 628.0452239825942,
 0.22916870645990625,
 0.10825034527036977,
 -0.17364817766693036,
 0.984807753012208,
 959.1071035774426,
 0.24144927391713714,
 0.10825034527036977,
 -0.058144828910475836,
 0.9983081582712682,
 237.45561945541016,
 0.24144927391713714,
 0.10825034527036977,
 0.058144828910475836,
 0.9983081582712682,
 201.9803677560994,
 0.22916870645990625,
 0.10825034527036977,
 0.17364817766693025,
 0.984807753012208,
 713.9010147736278,
 0.2063762262880709,
 0.10825034527036977,
 0.28680323271109015,
 0.9579895123154889,
 475.9367608494449,
 0.1762080690134896,
 0.10825034527036977,
 0.39607976603915673,
 0.918216106880274,
 173.5398475889388,
 0.14248629019761827,
 0.10825034527036977,
 0.49999999999999994,
 0.8660254037844387,
 328.8449956382683,
 0.14156490804623956,
 0.13948400953756926,
 -0.49999999999999994,
 0.8660254037844387,
 223.24680218247505,
 0.16942416882620967,
 0.13948400953756926,
 -0.39607976603915673,
 0.918216106880274,
 593.4558791381767,
 0.19365122424555709,
 0.13948400953756926,
 -0.2868032327110902,
 0.9579895123154889,
 676.0727199120503,
 0.2115907708181821,
 0.13948400953756926,
 -0.17364817766693036,
 0.984807753012208,
 928.786559985134,
 0.2211411890121099,
 0.13948400953756926,
 -0.058144828910475836,
 0.9983081582712682,
 337.90173020306844,
 0.2211411890121099,
 0.13948400953756926,
 0.058144828910475836,
 0.9983081582712682,
 314.3077244080227,
 0.2115907708181821,
 0.13948400953756926,
 0.17364817766693025,
 0.984807753012208,
 864.1498864897015,
 0.19365122424555709,
 0.13948400953756926,
 0.28680323271109015,
 0.9579895123154889,
 556.8888664677753,
 0.16942416882620967,
 0.13948400953756926,
 0.39607976603915673,
 0.918216106880274,
 220.73287589787927,
 0.14156490804623956,
 0.13948400953756926,
 0.49999999999999994,
 0.8660254037844387,
 398.37680592361556,
 0.12917898292161795,
 0.17467130219302177,
 -0.49999999999999994,
 0.8660254037844387,
 886.8369488155852,
 0.14794064281121025,
 0.17467130219302177,
 -0.39607976603915673,
 0.918216106880274,
 528.848048723711,
 0.1636456590991691,
 0.17467130219302177,
 -0.2868032327110902,
 0.9579895123154889,
 726.9708200665915,
 0.17496438493874492,
 0.17467130219302177,
 -0.17364817766693036,
 0.984807753012208,
 630.3170775452377,
 0.1808934867990415,
 0.17467130219302177,
 -0.058144828910475836,
 0.9983081582712682,
 588.2138505963308,
 0.1808934867990415,
 0.17467130219302177,
 0.058144828910475836,
 0.9983081582712682,
 412.73066312171846,
 0.17496438493874492,
 0.17467130219302177,
 0.17364817766693025,
 0.984807753012208,
 530.164361553995,
 0.1636456590991691,
 0.17467130219302177,
 0.28680323271109015,
 0.9579895123154889,
 503.59605339325554,
 0.14794064281121025,
 0.17467130219302177,
 0.39607976603915673,
 0.918216106880274,
 256.0878972362398,
 0.12917898292161795,
 0.17467130219302177,
 0.49999999999999994,
 0.8660254037844387,
 422.793514489883,
 0.1110172290872192,
 0.2138122232367274,
 -0.49999999999999994,
 0.8660254037844387,
 329.8231183867133,
 0.12334820527272235,
 0.2138122232367274,
 -0.39607976603915673,
 0.918216106880274,
 692.6068151992182,
 0.13340255758223993,
 0.2138122232367274,
 -0.2868032327110902,
 0.9579895123154889,
 660.0609369820115,
 0.1405149882356535,
 0.2138122232367274,
 -0.17364817766693036,
 0.984807753012208,
 423.46012694611954,
 0.14419945003841908,
 0.2138122232367274,
 -0.058144828910475836,
 0.9983081582712682,
 938.2067185768751,
 0.14419945003841908,
 0.2138122232367274,
 0.058144828910475836,
 0.9983081582712682,
 933.4682961627586,
 0.1405149882356535,
 0.2138122232367274,
 0.17364817766693025,
 0.984807753012208,
 628.443267617643,
 0.13340255758223993,
 0.2138122232367274,
 0.28680323271109015,
 0.9579895123154889,
 733.9086614886344,
 0.12334820527272235,
 0.2138122232367274,
 0.39607976603915673,
 0.918216106880274,
 967.7326226599013,
 0.1110172290872192,
 0.2138122232367274,
 0.49999999999999994,
 0.8660254037844387,
 657.2585794144811,
 0.09299142080558524,
 0.25690677266868617,
 -0.49999999999999994,
 0.8660254037844387,
 697.9104595065056,
 0.10111236957862275,
 0.25690677266868617,
 -0.39607976603915673,
 0.918216106880274,
 535.448180343423,
 0.10761091612683682,
 0.25690677266868617,
 -0.2868032327110902,
 0.9579895123154889,
 978.2024189969994,
 0.11214720050565996,
 0.25690677266868617,
 -0.17364817766693036,
 0.984807753012208,
 870.925812308762,
 0.11447853146729005,
 0.25690677266868617,
 -0.058144828910475836,
 0.9983081582712682,
 79.65608958283133,
 0.11447853146729005,
 0.25690677266868617,
 0.058144828910475836,
 0.9983081582712682,
 282.4838436488887,
 0.11214720050565996,
 0.25690677266868617,
 0.17364817766693025,
 0.984807753012208,
 369.7111173907951,
 0.10761091612683682,
 0.25690677266868617,
 0.28680323271109015,
 0.9579895123154889,
 603.6729612344359,
 0.10111236957862275,
 0.25690677266868617,
 0.39607976603915673,
 0.918216106880274,
 328.9162135089056,
 0.09299142080558524,
 0.25690677266868617,
 0.49999999999999994,
 0.8660254037844387,
 794.0529462343327,
 0.07719726785053897,
 0.30395495048889803,
 -0.49999999999999994,
 0.8660254037844387,
 251.48287392229918,
 0.08261706991825257,
 0.30395495048889803,
 -0.39607976603915673,
 0.918216106880274,
 599.0807676329316,
 0.08689468038078631,
 0.30395495048889803,
 -0.2868032327110902,
 0.9579895123154889,
 227.90282947751695,
 0.08985156677504147,
 0.30395495048889803,
 -0.17364817766693036,
 0.984807753012208,
 950.0451238650334,
 0.09136234045394366,
 0.30395495048889803,
 -0.058144828910475836,
 0.9983081582712682,
 573.8269734774026,
 0.09136234045394366,
 0.30395495048889803,
 0.058144828910475836,
 0.9983081582712682,
 260.295499597917,
 0.08985156677504147,
 0.30395495048889803,
 0.17364817766693025,
 0.984807753012208,
 787.427535427623,
 0.08689468038078631,
 0.30395495048889803,
 0.28680323271109015,
 0.9579895123154889,
 551.956998151182,
 0.08261706991825257,
 0.30395495048889803,
 0.39607976603915673,
 0.918216106880274,
 416.05968395073836,
 0.07719726785053897,
 0.30395495048889803,
 0.49999999999999994,
 0.8660254037844387,
 406.4125101432243,
 0.06404929900146607,
 0.35495675669736304,
 -0.49999999999999994,
 0.8660254037844387,
 281.45291571202114,
 0.06773113441890631,
 0.35495675669736304,
 -0.39607976603915673,
 0.918216106880274,
 930.8772991451077,
 0.07060697708660722,
 0.35495675669736304,
 -0.2868032327110902,
 0.9579895123154889,
 18.676911190536938,
 0.07258028134652834,
 0.35495675669736304,
 -0.17364817766693036,
 0.984807753012208,
 632.1275092422125,
 0.07358407586038346,
 0.35495675669736304,
 -0.058144828910475836,
 0.9983081582712682,
 916.2359898359118,
 0.07358407586038346,
 0.35495675669736304,
 0.058144828910475836,
 0.9983081582712682,
 400.1071291408089,
 0.07258028134652834,
 0.35495675669736304,
 0.17364817766693025,
 0.984807753012208,
 604.9222948561684,
 0.07060697708660722,
 0.35495675669736304,
 0.28680323271109015,
 0.9579895123154889,
 322.13690398911797,
 0.06773113441890631,
 0.35495675669736304,
 0.39607976603915673,
 0.918216106880274,
 415.35311483398954,
 0.06404929900146607,
 0.35495675669736304,
 0.49999999999999994,
 0.8660254037844387,
 103.57056914147056,
 0.05333704297867313,
 0.4099121912940811,
 -0.49999999999999994,
 0.8660254037844387,
 865.4879734491504,
 0.0558863312895079,
 0.4099121912940811,
 -0.39607976603915673,
 0.918216106880274,
 625.5123735908226,
 0.057861670721175325,
 0.4099121912940811,
 -0.2868032327110902,
 0.9579895123154889,
 921.2552315015319,
 0.05920940214225803,
 0.4099121912940811,
 -0.17364817766693036,
 0.984807753012208,
 65.87722849657018,
 0.059892653373177264,
 0.4099121912940811,
 -0.058144828910475836,
 0.9983081582712682,
 390.3087058784744,
 0.059892653373177264,
 0.4099121912940811,
 0.058144828910475836,
 0.9983081582712682,
 20.1767577571863,
 0.05920940214225803,
 0.4099121912940811,
 0.17364817766693025,
 0.984807753012208,
 741.6989919633904,
 0.057861670721175325,
 0.4099121912940811,
 0.28680323271109015,
 0.9579895123154889,
 443.4951931048168,
 0.0558863312895079,
 0.4099121912940811,
 0.39607976603915673,
 0.918216106880274,
 210.7622767480517,
 0.05333704297867313,
 0.4099121912940811,
 0.49999999999999994,
 0.8660254037844387,
 728.7076087414811};


#endif
